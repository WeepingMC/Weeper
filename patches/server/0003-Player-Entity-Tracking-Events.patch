From c1474c8053001ef6a04362e578499b441dbdd03d Mon Sep 17 00:00:00 2001
From: ysl3000 <yannicklamprecht@live.de>
Date: Mon, 12 Oct 2020 23:11:41 +0200
Subject: [PATCH] Player Entity Tracking Events

---
 .../java/net/minecraft/server/level/EntityPlayer.java  |  6 +++++-
 .../net/minecraft/server/level/EntityTrackerEntry.java | 10 ++++++++--
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/level/EntityPlayer.java b/src/main/java/net/minecraft/server/level/EntityPlayer.java
index 1161605d9f..1bcf6afcac 100644
--- a/src/main/java/net/minecraft/server/level/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/level/EntityPlayer.java
@@ -141,6 +141,7 @@ import net.minecraft.world.scores.ScoreboardTeamBase;
 import net.minecraft.world.scores.criteria.IScoreboardCriteria;
 import io.papermc.paper.event.packet.PlayerChunkLoadEvent; // Paper
 import io.papermc.paper.event.packet.PlayerChunkUnloadEvent; // Paper
+import de.craftstuebchen.weepermc.event.packet.PlayerUntrackEntityEvent; // Paper
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
@@ -613,7 +614,9 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
 
             Integer integer;
             while (j < i && (integer = this.removeQueue.poll()) != null) {
-                aint[j++] = integer.intValue();
+                int entityId = integer.intValue();
+                aint[j++] = entityId;
+                new PlayerUntrackEntityEvent(getBukkitEntity(), entityId, world.getEntity(entityId) != null ? world.getEntity(entityId).getBukkitEntity() : null).callEventIfRegistered();
             }
             // Paper end
 
@@ -1894,6 +1897,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     public void c(Entity entity) {
         if (entity instanceof EntityHuman) {
             this.playerConnection.sendPacket(new PacketPlayOutEntityDestroy(new int[]{entity.getId()}));
+            new PlayerUntrackEntityEvent(getBukkitEntity(), entity.getId(), entity.getBukkitEntity()).callEventIfRegistered(); // Paper
         } else {
             this.removeQueue.add((Integer) entity.getId()); // CraftBukkit - decompile error
         }
diff --git a/src/main/java/net/minecraft/server/level/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/level/EntityTrackerEntry.java
index e867d0e4b0..3030967dee 100644
--- a/src/main/java/net/minecraft/server/level/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/level/EntityTrackerEntry.java
@@ -1,10 +1,12 @@
 package net.minecraft.server.level;
 
+import com.destroystokyo.paper.PaperSkinParts;
+import com.destroystokyo.paper.SkinParts;
 import com.google.common.collect.Lists;
 import com.mojang.datafixers.util.Pair;
+import de.craftstuebchen.weepermc.event.packet.PlayerTrackEntityEvent; // Paper
 import java.util.Collection;
 import java.util.Collections;
-import java.util.HashSet;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Set;
@@ -310,7 +312,11 @@ public class EntityTrackerEntry {
         Packet<?> packet = this.tracker.P();
 
         this.headYaw = MathHelper.d(this.tracker.getHeadRotation() * 256.0F / 360.0F);
-        consumer.accept(packet);
+        // Paper start
+        if (PlayerTrackEntityEvent.getHandlerList().getRegisteredListeners().length == 0 || new PlayerTrackEntityEvent(entityplayer.getBukkitEntity(), tracker.getBukkitEntity()).callEvent()) {
+            consumer.accept(packet);
+        }
+        // Paper end
         if (!this.tracker.getDataWatcher().d()) {
             consumer.accept(new PacketPlayOutEntityMetadata(this.tracker.getId(), this.tracker.getDataWatcher(), true));
         }
-- 
2.31.1

