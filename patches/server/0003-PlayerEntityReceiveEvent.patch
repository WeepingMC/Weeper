From 96682572423da205319060edbcf2fbb6abd39c14 Mon Sep 17 00:00:00 2001
From: ysl3000 <yannicklamprecht@live.de>
Date: Mon, 12 Oct 2020 23:11:41 +0200
Subject: [PATCH] PlayerEntityReceiveEvent

---
 .../net/minecraft/server/EntityTrackerEntry.java    | 11 ++++++++++-
 .../bukkit/craftbukkit/event/CraftEventFactory.java | 13 +++++++++++++
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
index 4efc40c01..8a7ff63ce 100644
--- a/src/main/java/net/minecraft/server/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
@@ -17,6 +17,10 @@ import org.bukkit.entity.Player;
 import org.bukkit.event.player.PlayerVelocityEvent;
 // CraftBukkit end
 
+// Weeper  start
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.event.packet.PlayerEntityReceiveEvent;
+// Weeper  end
 public class EntityTrackerEntry {
 
     private static final Logger LOGGER = LogManager.getLogger();
@@ -282,7 +286,12 @@ public class EntityTrackerEntry {
         Packet<?> packet = this.tracker.P();
 
         this.headYaw = MathHelper.d(this.tracker.getHeadRotation() * 256.0F / 360.0F);
-        consumer.accept(packet);
+        // Weeper start
+        PlayerEntityReceiveEvent playerEntityReceiveEvent = CraftEventFactory.callPlayerEntityReceiveEvent(this.tracker, entityplayer);
+        if (!playerEntityReceiveEvent.isCancelled()) {
+            consumer.accept(packet);
+        }
+        // Weeper end
         if (!this.tracker.getDataWatcher().d()) {
             consumer.accept(new PacketPlayOutEntityMetadata(this.tracker.getId(), this.tracker.getDataWatcher(), true));
         }
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 71306b6ee..74bebac34 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -196,6 +196,7 @@ import org.bukkit.event.inventory.PrepareAnvilEvent;
 import org.bukkit.event.inventory.PrepareItemCraftEvent;
 import org.bukkit.event.inventory.PrepareSmithingEvent;
 import org.bukkit.event.inventory.TradeSelectEvent;
+import org.bukkit.event.packet.PlayerEntityReceiveEvent;
 import org.bukkit.event.player.PlayerBedEnterEvent;
 import org.bukkit.event.player.PlayerBedEnterEvent.BedEnterResult;
 import org.bukkit.event.player.PlayerBucketEmptyEvent;
@@ -1785,4 +1786,16 @@ public class CraftEventFactory {
 
         return event;
     }
+
+    /**
+     * PlayerEntityReceiveEvent
+     */
+    public static PlayerEntityReceiveEvent callPlayerEntityReceiveEvent(Entity entity, EntityPlayer entityPlayer) {
+        org.bukkit.entity.Player bukkitEntity = entityPlayer.getBukkitEntity();
+
+        PlayerEntityReceiveEvent event = new PlayerEntityReceiveEvent(bukkitEntity, entity.getBukkitEntity());
+        Bukkit.getPluginManager().callEvent(event);
+
+        return event;
+    }
 }
-- 
2.29.2

