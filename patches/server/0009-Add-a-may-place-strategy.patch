From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Yannick Lamprecht <yannicklamprecht@live.de>
Date: Tue, 12 Oct 2021 21:10:47 +0200
Subject: [PATCH] Add a may place strategy


diff --git a/src/main/java/net/minecraft/world/Container.java b/src/main/java/net/minecraft/world/Container.java
index 7437f01ca8f416e2c9150250e324af4725a4efb6..6e9898b6db914cd8b1ed5d64a4323035f1a97352 100644
--- a/src/main/java/net/minecraft/world/Container.java
+++ b/src/main/java/net/minecraft/world/Container.java
@@ -1,11 +1,14 @@
 package net.minecraft.world;
 
 import java.util.Set;
+import java.util.function.BiFunction;
+import java.util.function.Function;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.item.Item;
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.item.crafting.Recipe;
 import org.bukkit.craftbukkit.entity.CraftHumanEntity;
+import org.checkerframework.checker.nullness.qual.Nullable;
 // CraftBukkit end
 
 public interface Container extends Clearable {
@@ -88,4 +91,7 @@ public interface Container extends Clearable {
 
     int MAX_STACK = 64;
     // CraftBukkit end
+    // Weeper may place strategy - start
+    default void setMayPlaceStrategy(@Nullable BiFunction<Container, ItemStack, Boolean> mayPlaceStrategy){};
+    // Weeper may place strategy - end
 }
diff --git a/src/main/java/net/minecraft/world/inventory/AbstractContainerMenu.java b/src/main/java/net/minecraft/world/inventory/AbstractContainerMenu.java
index ca05d8e5ff1b8caa07c0e4f3e203abd46d7a7ede..e9fde4cdc35cfe83c52a0eb258b2ae566aeefc7d 100644
--- a/src/main/java/net/minecraft/world/inventory/AbstractContainerMenu.java
+++ b/src/main/java/net/minecraft/world/inventory/AbstractContainerMenu.java
@@ -13,6 +13,8 @@ import java.util.Objects;
 import java.util.Optional;
 import java.util.OptionalInt;
 import java.util.Set;
+import java.util.function.BiFunction;
+import java.util.function.Function;
 import java.util.function.Supplier;
 import javax.annotation.Nullable;
 import net.minecraft.CrashReport;
@@ -149,6 +151,11 @@ public abstract class AbstractContainerMenu {
         return slot;
     }
 
+    public void setMayPlaceStrategy(BiFunction<Container, ItemStack, Boolean> mayPlaceStrategy){
+        this.slots.forEach(slot -> slot.setMayPlaceStrategy(mayPlaceStrategy));
+    }
+
+
     protected DataSlot addDataSlot(DataSlot property) {
         this.dataSlots.add(property);
         this.remoteDataSlots.add(0);
diff --git a/src/main/java/net/minecraft/world/inventory/Slot.java b/src/main/java/net/minecraft/world/inventory/Slot.java
index 4468c415905f4b48aaa4269832ef725a8b9bc3ef..a5772e826dc854828b40cc04a6c42f5738f18a11 100644
--- a/src/main/java/net/minecraft/world/inventory/Slot.java
+++ b/src/main/java/net/minecraft/world/inventory/Slot.java
@@ -2,11 +2,14 @@ package net.minecraft.world.inventory;
 
 import com.mojang.datafixers.util.Pair;
 import java.util.Optional;
+import java.util.function.BiFunction;
+import java.util.function.Function;
 import javax.annotation.Nullable;
 import net.minecraft.resources.ResourceLocation;
 import net.minecraft.world.Container;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.item.ItemStack;
+import org.bukkit.Material;
 
 public class Slot {
     public final int slot;
@@ -14,6 +17,11 @@ public class Slot {
     public int index;
     public final int x;
     public final int y;
+    private @Nullable BiFunction<Container, ItemStack, Boolean> mayPlaceStrategy;
+
+    public void setMayPlaceStrategy(@Nullable BiFunction<Container, ItemStack, Boolean> mayPlaceStrategy){
+        this.mayPlaceStrategy = mayPlaceStrategy;
+    }
 
     public Slot(Container inventory, int index, int x, int y) {
         this.container = inventory;
@@ -44,7 +52,7 @@ public class Slot {
     }
 
     public boolean mayPlace(ItemStack stack) {
-        return true;
+        return this.mayPlaceStrategy != null ? mayPlaceStrategy.apply(container, stack): true;
     }
 
     public ItemStack getItem() {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftHumanEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftHumanEntity.java
index 7c7d05852dd463331110d1dcb71b4d4f5312900f..8bfe1150be99b2a543b793b3b7cb28c3870de88d 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftHumanEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftHumanEntity.java
@@ -7,6 +7,8 @@ import java.util.Arrays;
 import java.util.Collection;
 import java.util.Optional;
 import java.util.Set;
+import java.util.function.BiFunction;
+
 import net.minecraft.core.BlockPos;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.network.chat.Component;
@@ -45,13 +47,13 @@ import org.bukkit.craftbukkit.inventory.CraftInventoryPlayer;
 import org.bukkit.craftbukkit.inventory.CraftInventoryView;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.craftbukkit.inventory.CraftMerchantCustom;
-import org.bukkit.craftbukkit.util.CraftChatMessage;
 import org.bukkit.craftbukkit.util.CraftMagicNumbers;
 import org.bukkit.craftbukkit.util.CraftNamespacedKey;
 import org.bukkit.entity.HumanEntity;
 import org.bukkit.entity.Villager;
 import org.bukkit.inventory.EntityEquipment;
 import org.bukkit.inventory.Inventory;
+import org.bukkit.inventory.InventoryHolder;
 import org.bukkit.inventory.InventoryView;
 import org.bukkit.inventory.ItemStack;
 import org.bukkit.inventory.MainHand;
@@ -62,6 +64,7 @@ import org.bukkit.permissions.Permission;
 import org.bukkit.permissions.PermissionAttachment;
 import org.bukkit.permissions.PermissionAttachmentInfo;
 import org.bukkit.plugin.Plugin;
+import org.checkerframework.checker.nullness.qual.Nullable;
 
 public class CraftHumanEntity extends CraftLivingEntity implements HumanEntity {
     private CraftInventoryPlayer inventory;
@@ -294,6 +297,10 @@ public class CraftHumanEntity extends CraftLivingEntity implements HumanEntity {
 
     @Override
     public InventoryView openInventory(Inventory inventory) {
+        return openInventory(inventory, null);
+    }
+    @Override
+    public InventoryView openInventory(Inventory inventory, BiFunction<InventoryHolder, ItemStack, Boolean> mayPlaceStrategy) {
         if (!(this.getHandle() instanceof ServerPlayer)) return null;
         ServerPlayer player = (ServerPlayer) this.getHandle();
         AbstractContainerMenu formerContainer = this.getHandle().containerMenu;
@@ -323,7 +330,7 @@ public class CraftHumanEntity extends CraftLivingEntity implements HumanEntity {
         if (iinventory instanceof MenuProvider) {
             this.getHandle().openMenu(iinventory);
         } else {
-            CraftHumanEntity.openCustomInventory(inventory, player, container);
+                CraftHumanEntity.openCustomInventory(inventory, player, container, mayPlaceStrategy);
         }
 
         if (this.getHandle().containerMenu == formerContainer) {
@@ -334,9 +341,15 @@ public class CraftHumanEntity extends CraftLivingEntity implements HumanEntity {
     }
 
     private static void openCustomInventory(Inventory inventory, ServerPlayer player, MenuType<?> windowType) {
+        openCustomInventory( inventory, player, windowType, null);
+    }
+    private static void openCustomInventory(Inventory inventory, ServerPlayer player, MenuType<?> windowType, @Nullable BiFunction<InventoryHolder, ItemStack, Boolean> mayPlaceStrategy) {
         if (player.connection == null) return;
         Preconditions.checkArgument(windowType != null, "Unknown windowType");
         AbstractContainerMenu container = new CraftContainer(inventory, player, player.nextContainerCounter());
+        if(mayPlaceStrategy != null){
+            container.setMayPlaceStrategy((interactedContainer, itemStack) -> mayPlaceStrategy.apply(interactedContainer.getOwner(),CraftItemStack.asBukkitCopy(itemStack)));
+        }
 
         container = CraftEventFactory.callInventoryOpenEvent(player, container);
         if (container == null) return;
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
index 396a4ae3d5a829eda78ef98561333aea300aa722..89363386a44c3373b86c63ef8d8c5ae32a853c70 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
@@ -3,6 +3,8 @@ package org.bukkit.craftbukkit.inventory;
 import java.util.HashMap;
 import java.util.List;
 import java.util.ListIterator;
+import java.util.function.BiFunction;
+import java.util.function.Function;
 import net.minecraft.world.Container;
 import net.minecraft.world.inventory.CraftingContainer;
 import net.minecraft.world.inventory.MerchantContainer;
@@ -26,6 +28,7 @@ import org.bukkit.entity.HumanEntity;
 import org.bukkit.event.inventory.InventoryType;
 import org.bukkit.inventory.Inventory;
 import org.bukkit.inventory.InventoryHolder;
+import org.bukkit.inventory.InventoryView;
 import org.bukkit.inventory.ItemStack;
 
 public class CraftInventory implements Inventory {
@@ -567,4 +570,9 @@ public class CraftInventory implements Inventory {
     public Location getLocation() {
         return this.inventory.getLocation();
     }
+
+    @Override
+    public void setMayPlaceStrategy(BiFunction<InventoryHolder, ItemStack, Boolean> mayPlaceStrategy) {
+        this.inventory.setMayPlaceStrategy((container, itemStack) -> mayPlaceStrategy.apply(container.getOwner(), CraftItemStack.asBukkitCopy(itemStack)));
+    }
 }
