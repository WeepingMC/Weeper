From 37e3945650548740d1edbe77db1c7c88ec2e3738 Mon Sep 17 00:00:00 2001
From: Yannick Lamprecht <yannicklamprecht@live.de>
Date: Mon, 1 Feb 2021 02:33:26 +0100
Subject: [PATCH] player abilities

---
 .../packet/CraftPacketConversion.java         | 25 ++++++++++++++++++-
 .../packet/CraftPacketStepBuilder.java        | 11 ++++++++
 2 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketConversion.java b/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketConversion.java
index 472c365b8..e923a0e98 100644
--- a/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketConversion.java
+++ b/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketConversion.java
@@ -3,6 +3,7 @@ package de.craftstuebchen.weepermc.packet;
 import com.mojang.datafixers.util.Pair;
 
 import de.craftstuebchen.weepermc.packet.options.Animation;
+import de.craftstuebchen.weepermc.packet.options.PlayerAbility;
 import de.craftstuebchen.weepermc.packet.options.TeamMode;
 import net.minecraft.network.protocol.game.PacketPlayOutPlayerInfo;
 
@@ -11,11 +12,11 @@ import org.bukkit.inventory.EquipmentSlot;
 
 import de.craftstuebchen.weepermc.packet.options.EntityStatus;
 import de.craftstuebchen.weepermc.packet.options.ProfileAction;
+
 import net.minecraft.world.entity.EnumItemSlot;
 import net.minecraft.world.entity.player.PlayerAbilities;
 import net.minecraft.world.item.ItemStack;
 
-
 import java.util.ArrayList;
 import java.util.EnumMap;
 import java.util.List;
@@ -134,4 +135,26 @@ public final class CraftPacketConversion {
         }
         throw new UnsupportedOperationException("Invalid case!");
     }
+
+    static PlayerAbilities mapPlayerAbilities(Set<PlayerAbility> playerAbilities) {
+        PlayerAbilities playerAbilitiesNMS = new PlayerAbilities();
+
+        for (PlayerAbility playerAbilitiy : playerAbilities) {
+            switch (playerAbilitiy) {
+                case INVULNERABLE:
+                    playerAbilitiesNMS.isInvulnerable = true;
+                    break;
+                case FLYING:
+                    playerAbilitiesNMS.isFlying = true;
+                    break;
+                case ALLOW_FLYING:
+                    playerAbilitiesNMS.canFly = true;
+                    break;
+                case CREATIVE_MODE_INSTANT_BREAK:
+                    playerAbilitiesNMS.canInstantlyBuild = true;
+                    break;
+            }
+        }
+        return playerAbilitiesNMS;
+    }
 }
diff --git a/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketStepBuilder.java b/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketStepBuilder.java
index 95a802e00..1a397aa28 100644
--- a/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketStepBuilder.java
+++ b/src/main/java/de/craftstuebchen/weepermc/packet/CraftPacketStepBuilder.java
@@ -54,10 +54,12 @@ import java.util.Collection;
 import java.util.Collections;
 import java.util.List;
 import java.util.Optional;
+import java.util.Set;
 import java.util.UUID;
 import java.util.concurrent.TimeUnit;
 
 import static de.craftstuebchen.weepermc.packet.CraftPacketConversion.from;
+import static de.craftstuebchen.weepermc.packet.CraftPacketConversion.mapPlayerAbilities;
 
 import javax.annotation.Nonnull;
 
@@ -229,6 +231,15 @@ public class CraftPacketStepBuilder implements PacketStepBuilder {
         return this;
     }
 
+    @Override
+    public PacketStepBuilder playerAbilities(@Nonnull Set<PlayerAbility> playerAbilities, float flySpeed, float fieldOfViewModifier) {
+        PlayerAbilities playerAbilitiesNMS = mapPlayerAbilities(playerAbilities);
+        playerAbilitiesNMS.flySpeed = flySpeed;
+        playerAbilitiesNMS.walkSpeed = fieldOfViewModifier;
+        initial.setNext(of(new PacketPlayOutAbilities(playerAbilitiesNMS)));
+        return this;
+    }
+
     @Override
     public void send(@Nonnull Collection<? extends Player> players){
         initial.execute(players);
-- 
2.32.0

